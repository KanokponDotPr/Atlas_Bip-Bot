#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <EEPROM.h>

#define EEPROM_SIZE 128

ESP8266WebServer server(80);

struct Config {
  char ssid[32];
  char password[32];
  char serverIP[16];
};

Config config;

bool configMode = false;

void loadConfig() {
  EEPROM.begin(EEPROM_SIZE);
  EEPROM.get(0, config);
  EEPROM.end();

  if (strlen(config.ssid) == 0) {
    strcpy(config.ssid, "BipbotS1_Name"); // à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
    strcpy(config.password, "BipbotS1_Password");
    strcpy(config.serverIP, "BipbotS1_Server");
  }
}

void saveConfig() {
  EEPROM.begin(EEPROM_SIZE);
  EEPROM.put(0, config);
  EEPROM.commit();
  EEPROM.end();
}

void handleRoot() {
  String html = "<html><body><h2>BipBot C1a Config</h2>"
                "<form action='/save' method='post'>"
                "WiFi SSID: <input name='ssid' value='" + String(config.ssid) + "'><br><br>"
                "Password: <input name='password' type='password' value='" + String(config.password) + "'><br><br>"
                "Server IP: <input name='serverIP' value='" + String(config.serverIP) + "'><br><br>"
                "<input type='submit' value='Save & Connect'>"
                "</form></body></html>";
  server.send(200, "text/html", html);
}

void handleSave() {
  String ssid = server.arg("ssid");
  String password = server.arg("password");
  String serverIP = server.arg("serverIP");

  ssid.toCharArray(config.ssid, sizeof(config.ssid));
  password.toCharArray(config.password, sizeof(config.password));
  serverIP.toCharArray(config.serverIP, sizeof(config.serverIP));

  saveConfig();

  server.send(200, "text/html", "<html><body><h3>Saved! Rebooting...</h3></body></html>");
  delay(2000);
  ESP.restart();
}

void startConfigMode() {
  configMode = true;
  WiFi.mode(WIFI_AP);
  WiFi.softAP("BipBotC1a", "bb12345678");

  Serial.println("ðŸ”§ Config Mode Active");
  Serial.print("AP IP: ");
  Serial.println(WiFi.softAPIP());

  server.on("/", handleRoot);
  server.on("/save", handleSave);
  server.begin();
  Serial.println("HTTP server started (config mode)");
}

void connectToWiFi() {
  WiFi.mode(WIFI_STA);
  WiFi.begin(config.ssid, config.password);

  Serial.print("Connecting to WiFi ");
  Serial.println(config.ssid);

  unsigned long startAttemptTime = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startAttemptTime < 10000) {
    delay(500);
    Serial.print(".");
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… Connected!");
    Serial.print("IP: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nâš ï¸ Failed to connect. Switching to config mode.");
    startConfigMode();
  }
}

void setup() {
  Serial.begin(115200);
  loadConfig();

  if (strlen(config.ssid) == 0) {
    Serial.println("âš™ï¸ No config found, entering setup mode.");
    startConfigMode();
  } else {
    connectToWiFi();
  }
}

void loop() {
  if (configMode) {
    server.handleClient();
  } else {
    // --- à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰à¸„à¸·à¸­à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸›à¸à¸•à¸´à¸‚à¸­à¸‡ Client ---
    WiFiClient client;
    if (client.connect(config.serverIP, 80)) {
      String url = "/data?value=" + String(random(0, 100));
      client.print(String("GET ") + url + " HTTP/1.1\r\n" +
                   "Host: " + config.serverIP + "\r\n" +
                   "Connection: close\r\n\r\n");
      Serial.println("ðŸ“¤ Sent value to server.");
      client.stop();
    } else {
      Serial.println("âŒ Failed to connect to server");
    }
    delay(5000);
  }
}
